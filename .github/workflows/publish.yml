name: Publish On Tag

on:
  push:
    branches:
      - workflows

jobs:
  publish:
#    needs: [initial-check]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v2
      - uses: ilammy/msvc-dev-cmd@v1.4.1
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build executable
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pyinstaller --noconfirm --onefile --console --add-data "*.py:."  "lucky_imaging_tool.py"

      # - name: Fail on tag and module version mismatch
      #   if: (!endsWith(github.ref, steps.get_module_version.outputs.version))
      #   run: |
      #     echo "Ref that triggered release: ${{ github.ref }}"
      #     echo "Current module version: ${{ steps.get_module_version.outputs.version }}"
      #     exit 1

      # - name: Get documented version changes from CHANGELOG.md
      #   id: get_documented_changes
      #   shell: bash
      #   run: |
      #     changes="$(
      #       found_version=0; \
      #       while IFS= read -r line; do \
      #         if [[ $found_version == 0 ]]; then\
      #           if [[ $line == *"${{ steps.get_module_version.outputs.version }}"* && $line == "##"* ]]; then \
      #             found_version=1; \
      #           fi \
      #         else \
      #         if [[ $line == "##"* ]]; then \
      #           found_version=0; \
      #         else \
      #           echo "$line"; \
      #         fi \
      #         fi \
      #       done < CHANGELOG.md
      #     )"

      #     echo "Documented changes:"
      #     echo "$changes"
      #     echo ""

      #     if [[ $changes == "" ]]; then \
      #       echo "Changes have not been documented"; \
      #       exit 1; \
      #     else \
      #       changes="${changes//'%'/'%25'}"; \
      #       changes="${changes//$'\n'/'%0A'}"; \
      #       changes="${changes//$'\r'/'%0D'}"; \
      #       echo "::set-output name=changes::$changes"; \
      #     fi

      # - name: Build distribution
      #   run: |
      #     python setup.py sdist bdist_wheel --universal

      # - name: Publish package
      #   uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     user: __token__
      #     password: ${{ secrets.pypi_password }}

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v3_test
          release_name: v3_test
          draft: false
          prerelease: false
#          body: ${{ steps.get_documented_changes.outputs.changes }}

      - name: Upload Binary to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/lucky_imaging_tool
          asset_name: luck_imaging_tool
          asset_content_type: application/octet-stream
